<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>RP-Pakstation Visual</title>
<style>
body {
    font-family: Arial, sans-serif;
    background: #2c2f33;
    color: #fff;
    display: flex;
    justify-content: center;
    padding: 50px;
}
#pakstation {
    background: #f5f5f5;
    color: #333;
    padding: 20px;
    border-radius: 20px;
    width: 1000px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.4);
}
h1, h2, h3 { text-align: center; }
input {
    width: 200px;
    padding: 10px;
    margin: 5px;
    border-radius: 10px;
    border: none;
    font-size: 16px;
}
button {
    padding: 10px 20px;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    background: #ffcc00;
    cursor: pointer;
}
#ergebnis, #loginErgebnis, #postlerErgebnis {
    margin: 10px 0;
    height: 20px;
}
#fachRaster {
    display: grid;
    grid-template-columns: repeat(10, 80px);
    grid-gap: 10px;
    justify-content: center;
    margin-top: 20px;
}
.fach {
    width: 80px;
    height: 60px;
    background: #ddd;
    border-radius: 5px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: bold;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: all 0.5s;
}
.fach.eingelagert { background: #f5a623; }  
.fach.abgeholt { background: #28a745; color: white; }  
.fach.geoeffnet { transform: scale(1.2); z-index: 10; background: #ffeb3b; }
.paket {
    width: 60px;
    height: 40px;
    background: #fff;
    border-radius: 5px;
    display: flex;
    justify-content: center;
    align-items: center;
    position: absolute;
    transition: all 0.5s;
}
hr { margin: 30px 0; border: 1px solid #ccc; }
</style>
</head>
<body>
<div id="pakstation">
    <h1>üì¶ RP-Pakstation</h1>
    <input type="text" id="paketID" placeholder="SCH-123456">
    <input type="text" id="empfaenger" placeholder="Dein Name">
    <button id="btnAbholen">Best√§tigen</button>
    <div id="ergebnis"></div>
    <div id="fachRaster"></div>

    <hr>
    <h2>üöö Postler Login</h2>
    <div id="loginPanel">
        <input type="text" id="loginUser" placeholder="Benutzername">
        <input type="password" id="loginPass" placeholder="Passwort">
        <button id="btnLogin">Login</button>
        <div id="loginErgebnis"></div>
    </div>

    <div id="postlerPanel" style="display:none; margin-top:20px;">
        <h3>üì¶ Paket hinzuf√ºgen</h3>
        <input type="text" id="neuPaketID" placeholder="SCH-123456">
        <input type="text" id="neuEmpfaenger" placeholder="Empf√§nger Name">
        <input type="number" id="neuFachnummer" placeholder="Fachnummer">
        <button id="btnHinzufuegen">Hinzuf√ºgen</button>
        <h3>üóëÔ∏è Paket l√∂schen</h3>
        <input type="text" id="delPaketID" placeholder="Paket ID">
        <button id="btnLoeschen">L√∂schen</button>
        <div id="postlerErgebnis"></div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const SUPABASE_URL = "https://djcjaojwtampvfceuvfj.supabase.co";
    const SUPABASE_KEY = "sb_publishable_Iz4y0T-WdQ-X3D2pViUKjg_i7g1AHn0";

    const fachRaster = document.getElementById("fachRaster");
    const ergebnis = document.getElementById("ergebnis");
    const fachAnzahl = 30;
    let pakete = [];

    // Raster erstellen
    for (let i = 0; i < fachAnzahl; i++) {
        const div = document.createElement("div");
        div.className = "fach";
        div.dataset.index = i;
        div.textContent = i + 1;
        fachRaster.appendChild(div);
    }

    // Pakete laden
    async function ladePakete() {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/pakete`, {
            headers: {
                "apikey": SUPABASE_KEY,
                "Authorization": `Bearer ${SUPABASE_KEY}`,
                "Accept": "application/json"
            }
        });
        if (!res.ok) { ergebnis.textContent = "‚ùå Supabase REST Fehler"; return; }
        pakete = await res.json();
        renderFaecher();
    }

    function renderFaecher() {
        document.querySelectorAll(".fach").forEach(div => {
            const idx = Number(div.dataset.index);
            const paket = pakete.find(p => p.fachnummer === idx);
            div.className = "fach";
            div.innerHTML = idx + 1;
            if (!paket) return;
            div.classList.add(paket.status);
            if (paket.status !== "abgeholt") {
                const p = document.createElement("div");
                p.className = "paket";
                p.textContent = "üì¶";
                div.appendChild(p);
            }
        });
    }

    // Paket abholen
    const paketID = document.getElementById("paketID");
    const empfaenger = document.getElementById("empfaenger");
    const btnAbholen = document.getElementById("btnAbholen");

    btnAbholen.addEventListener("click", async () => {
        const id = paketID.value.trim();
        const name = empfaenger.value.trim();
        const paket = pakete.find(p => p.id === id);
        if (!paket || paket.empfaenger.toLowerCase() !== name.toLowerCase()) {
            ergebnis.textContent = "‚ùå Daten falsch"; return;
        }
        await fetch(`${SUPABASE_URL}/rest/v1/pakete?id=eq.${paket.id}`, {
            method: "PATCH",
            headers: {
                "apikey": SUPABASE_KEY,
                "Authorization": `Bearer ${SUPABASE_KEY}`,
                "Content-Type": "application/json",
                "Prefer": "return=minimal"
            },
            body: JSON.stringify({status:"abgeholt", timestamp: new Date().toISOString()})
        });
        paket.status = "abgeholt";
        renderFaecher();
        ergebnis.textContent = `‚úÖ Paket f√ºr ${paket.empfaenger} abgeholt`;
        paketID.value = ""; empfaenger.value = "";
    });

    // Postler Login
    const loginUser = document.getElementById("loginUser");
    const loginPass = document.getElementById("loginPass");
    const btnLogin = document.getElementById("btnLogin");
    const loginErgebnis = document.getElementById("loginErgebnis");
    const postlerPanel = document.getElementById("postlerPanel");

    btnLogin.addEventListener("click", async () => {
        const username = loginUser.value.trim();
        const password = loginPass.value.trim();
        if (!username || !password) { loginErgebnis.textContent="‚ö†Ô∏è Bitte ausf√ºllen"; return; }

        const res = await fetch(`${SUPABASE_URL}/rest/v1/postler?username=eq.${username}&password=eq.${password}`, {
            headers: {
                "apikey": SUPABASE_KEY,
                "Authorization": `Bearer ${SUPABASE_KEY}`,
                "Accept": "application/json"
            }
        });
        const data = await res.json();
        if (data.length===0) { loginErgebnis.textContent="‚ùå Falscher Benutzer oder Passwort"; return; }

        loginErgebnis.textContent = `‚úÖ Willkommen ${username}`;
        postlerPanel.style.display = "block";
        loginUser.value = ""; loginPass.value = "";
    });

    // Paket hinzuf√ºgen
    const neuPaketID = document.getElementById("neuPaketID");
    const neuEmpfaenger = document.getElementById("neuEmpfaenger");
    const neuFachnummer = document.getElementById("neuFachnummer");
    const btnHinzufuegen = document.getElementById("btnHinzufuegen");
    const postlerErgebnis = document.getElementById("postlerErgebnis");

    btnHinzufuegen.addEventListener("click", async () => {
        const id = neuPaketID.value.trim();
        const empfaenger = neuEmpfaenger.value.trim();
        const fach = parseInt(neuFachnummer.value);
        if (!id||!empfaenger||isNaN(fach)) { postlerErgebnis.textContent="‚ö†Ô∏è Alle Felder ausf√ºllen"; return; }

        const res = await fetch(`${SUPABASE_URL}/rest/v1/pakete`, {
            method:"POST",
            headers:{
                "apikey":SUPABASE_KEY,
                "Authorization":`Bearer ${SUPABASE_KEY}`,
                "Content-Type":"application/json",
                "Prefer":"return=minimal"
            },
            body:JSON.stringify({id, empfaenger, fachnummer:fach, status:"eingelagert", timestamp:new Date().toISOString()})
        });
        if(!res.ok){ postlerErgebnis.textContent="‚ùå Fehler beim Hinzuf√ºgen"; return; }

        postlerErgebnis.textContent = `‚úÖ Paket ${id} hinzugef√ºgt`;
        neuPaketID.value = ""; neuEmpfaenger.value=""; neuFachnummer.value="";
        ladePakete();
    });

    // Paket l√∂schen
    const delPaketID = document.getElementById("delPaketID");
    const btnLoeschen = document.getElementById("btnLoeschen");

    btnLoeschen.addEventListener("click", async () => {
        const id = delPaketID.value.trim();
        if(!id){ postlerErgebnis.textContent="‚ö†Ô∏è Paket ID eingeben"; return; }

        const res = await fetch(`${SUPABASE_URL}/rest/v1/pakete?id=eq.${id}`, {
            method:"DELETE",
            headers:{
                "apikey":SUPABASE_KEY,
                "Authorization":`Bearer ${SUPABASE_KEY}`,
                "Prefer":"return=minimal"
            }
        });
        if(!res.ok){ postlerErgebnis.textContent="‚ùå Fehler beim L√∂schen"; return; }

        postlerErgebnis.textContent = `‚úÖ Paket ${id} gel√∂scht`;
        delPaketID.value="";
        ladePakete();
    });

    ladePakete();
});
</script>
</body>
</html>
